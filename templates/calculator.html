
{% extends "base.html" %}

{% block title %}
    Calculadora {{ producto.nombre }} - {{ plazo_info.nombre }} | MoneyMax
{% endblock %}

{% block head %}
<style>
/* ──────────── ESTILOS ──────────── */
.product-header{background:linear-gradient(135deg,{{ producto.color_fondo }},{{ producto.color_fondo }}dd);color:#fff;padding:2rem 0}
.calculator-container{display:grid;grid-template-columns:1fr 1fr;gap:3rem;max-width:1200px;margin:0 auto;padding:3rem 2rem}
.form-section,.results-section{background:#fff;border-radius:16px;padding:2rem;box-shadow:0 4px 6px rgba(0,0,0,.05);border:1px solid #e2e8f0}
.form-group{margin-bottom:1.5rem}.form-label{display:block;font-weight:600;color:#2d3748;margin-bottom:.5rem;font-size:.9rem}
.form-input{width:100%;padding:.75rem 1rem;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;transition:border-color .3s}
.form-input:focus{outline:none;border-color:{{ producto.color_fondo }};box-shadow:0 0 0 3px rgba(66,153,225,.1)}
.radio-group{display:flex;gap:1rem;margin-top:.5rem}.radio-option{flex:1;position:relative}
.radio-input{position:absolute;opacity:0;pointer-events:none}
.radio-label{display:block;padding:1rem;border:2px solid #e2e8f0;border-radius:8px;text-align:center;cursor:pointer;transition:.3s;font-weight:500}
.radio-input:checked+.radio-label{border-color:{{ producto.color_fondo }};background:linear-gradient(135deg,{{ producto.color_fondo }}10,{{ producto.color_fondo }}05);color:{{ producto.color_fondo }}}
.calculate-button{width:100%;background:linear-gradient(135deg,{{ producto.color_fondo }},{{ producto.color_fondo }}dd);color:#fff;border:none;padding:1rem 2rem;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:.3s}
.calculate-button:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.15)}
.calculate-button:disabled{opacity:.6;cursor:not-allowed;transform:none}
.result-card{background:linear-gradient(135deg,#f8fafc,#fff);border:1px solid #e2e8f0;border-radius:12px;padding:1.5rem;margin-bottom:1rem;text-align:center}
.result-amount{font-size:2rem;font-weight:800;color:{{ producto.color_fondo }};margin-bottom:.25rem}.result-label{color:#718096;font-size:.9rem;font-weight:500}
.metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:1rem;margin:1.5rem 0}
.metric-item{text-align:center;padding:1rem;background:#f7fafc;border-radius:8px}.metric-value{font-size:1.1rem;font-weight:700;color:#2d3748}
.metric-label{font-size:.8rem;color:#718096;margin-top:.25rem}
.chart-container{margin:2rem 0;min-height:400px}.table-container{margin-top:2rem;max-height:300px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:8px}
.data-table{width:100%;border-collapse:collapse}.data-table th{background:#f7fafc;padding:.75rem;text-align:left;font-weight:600;color:#2d3748;font-size:.85rem;border-bottom:1px solid #e2e8f0;position:sticky;top:0}
.data-table td{padding:.75rem;border-bottom:1px solid #f1f3f4;font-size:.85rem}
.back-button{display:inline-flex;align-items:center;gap:.5rem;background:rgba(255,255,255,.2);color:#fff;padding:.75rem 1.5rem;border-radius:8px;text-decoration:none;font-weight:500;transition:.3s;margin-bottom:1rem}
.back-button:hover{background:rgba(255,255,255,.3);transform:translateX(-2px)}
.steps-indicator{display:flex;justify-content:center;align-items:center;gap:1rem;margin-bottom:1rem}
.step{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;color:#fff}
.step.active{background:{{ producto.color_fondo }}}.step.completed{background:#48bb78}
.step-divider{width:40px;height:2px;background:#cbd5e0}.step-divider.completed{background:#48bb78}
.error-message{background:#fed7d7;color:#c53030;padding:.75rem 1rem;border-radius:6px;font-size:.9rem;margin-top:.5rem;display:none}
.success-message{background:#c6f6d5;color:#276749;padding:.75rem 1rem;border-radius:6px;font-size:.9rem;margin-top:.5rem;display:none}
.loading{display:none;text-align:center;color:#718096;font-style:italic;margin-top:1rem}
.auto-calc-indicator{font-size:.8rem;color:#48bb78;margin-top:.5rem;text-align:center;display:none}
@media (max-width:768px){.calculator-container{grid-template-columns:1fr;gap:2rem;padding:2rem 1rem}.radio-group{flex-direction:column}.metrics-grid{grid-template-columns:repeat(2,1fr)}}
</style>
{% endblock %}

{% block content %}
<!-- ──────────── ENCABEZADO DE PRODUCTO ──────────── -->
<section class="product-header">
    <div class="container">
        <a href="/calculator/{{ producto_id }}" class="back-button">← Cambiar plazo</a>

        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
            <div style="display:flex;align-items:center;gap:2rem">
                <div style="width:80px;height:80px;background:rgba(255,255,255,.2);border-radius:12px;display:flex;align-items:center;justify-content:center">
                    {% if producto.logo %}
                        <img src="{{ producto.logo }}" alt="{{ producto.nombre }}" style="width:60px;height:60px;object-fit:contain;border-radius:8px">
                    {% else %}
                        <div style="font-size:2rem;font-weight:bold;color:#fff">
                            {% set w = producto.nombre.split() %}
                            {% if w|length == 1 %}
                                {{ producto.nombre[:2].upper() }}
                            {% else %}
                                {{ w[0][0].upper() + w[1][0].upper() }}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>

                <div>
                    <h1 style="font-size:2rem;font-weight:700;margin-bottom:.25rem">{{ producto.nombre }}</h1>
                    <p style="font-size:1.1rem;opacity:.9;margin-bottom:.25rem">
                        {{ plazo_info.nombre }} – {{ "%.2f"|format(plazo_info.tasa_anual) }} % anual
                    </p>
                    <p style="font-size:.9rem;opacity:.8">{{ plazo_info.descripcion }}</p>
                </div>
            </div>

            <div style="text-align:right;color:rgba(255,255,255,.8);font-size:.9rem">
                Paso 3 de 3<br><strong>Cálculo</strong>
            </div>
        </div>

        <div class="steps-indicator">
            <div class="step completed">1</div>
            <div class="step-divider completed"></div>
            <div class="step completed">2</div>
            <div class="step-divider completed"></div>
            <div class="step active">3</div>
        </div>
    </div>
</section>

<!-- ──────────── CALCULADORA ──────────── -->
<section>
    <div class="calculator-container">
        <!-- FORMULARIO -->
        <div class="form-section">
            <h2 style="font-size:1.5rem;font-weight:700;color:#2d3748;margin-bottom:1.5rem">
                Configura tu inversión
            </h2>

            <form id="calculatorForm">
                <div class="form-group">
                    <label class="form-label">Tipo de inversión</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="simple" name="tipo_inversion" value="simple"
                                   class="radio-input" checked>
                            <label for="simple" class="radio-label">
                                <strong>Inversión única</strong><br><small>Un solo monto</small>
                            </label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="mensual" name="tipo_inversion" value="mensual"
                                   class="radio-input">
                            <label for="mensual" class="radio-label">
                                <strong>Inversión mensual</strong><br><small>Aportaciones constantes</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="monto" class="form-label" id="montoLabel">Monto a invertir (MXN)</label>
                    <input type="number" id="monto" name="monto" class="form-input"
                           placeholder="1,000" value="1000"
                           min="100" max="50000000" step="100" required>
                    <div id="montoError" class="error-message"></div>
                    <div id="montoSuccess" class="success-message"></div>
                </div>

                <div class="form-group" id="plazoSelectGroup" style="display:none;">
                    <label for="plazoMesesSelect" class="form-label">Plazo de la corrida</label>
                    <select id="plazoMesesSelect" name="plazo_meses" class="form-input"></select>
                    <div style="font-size:.8rem;color:#718096;margin-top:.25rem">
                        ¿Por cuánto tiempo harás aportaciones mensuales?
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Producto seleccionado</label>
                    <div style="background:#f7fafc;padding:1rem;border-radius:8px;border:1px solid #e2e8f0">
                        <div style="font-weight:600;color:#2d3748">{{ plazo_info.nombre }}</div>
                        <div style="color:#718096;font-size:.9rem">
                            {{ "%.2f"|format(plazo_info.tasa_anual) }} % anual
                        </div>
                    </div>
                </div>

                <button type="button" class="calculate-button" id="calculateBtn" onclick="forceCalculate()">
                    Calcular rendimiento
                </button>
                
                <div class="auto-calc-indicator" id="autoCalcIndicator">
                    ✓ Calculando automáticamente...
                </div>
            </form>

            <div id="loading" class="loading">Calculando rendimientos...</div>
        </div>

        <!-- RESULTADOS -->
        <div class="results-section">
            <h2 style="font-size:1.5rem;font-weight:700;color:#2d3748;margin-bottom:1.5rem">
                Resultados
            </h2>

            <div id="results" style="display:none">
                <div class="result-card">
                    <div class="result-amount" id="montoFinal">$0.00</div>
                    <div class="result-label">Monto final</div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-value" id="rendimientoTotal">$0.00</div>
                        <div class="metric-label">Rendimiento</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="tasaEfectiva">0.00 %</div>
                        <div class="metric-label">Tasa efectiva</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="montoInicial">$0.00</div>
                        <div class="metric-label" id="montoInicialLabel">Inversión inicial</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="plazoMesesRes">0</div>
                        <div class="metric-label">Meses</div>
                    </div>
                </div>

                <div class="chart-container"><div id="chart"></div></div>

                <div class="table-container">
                    <table class="data-table" id="dataTable">
                        <thead><tr id="tableHeaders"></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="noResults" style="text-align:center;color:#718096;padding:3rem 0">
                <div style="width:60px;height:60px;background:#f1f3f4;border-radius:50%;
                            display:flex;align-items:center;justify-content:center;margin:0 auto 1rem;opacity:.5">
                    <div style="width:24px;height:24px;background:#cbd5e0;border-radius:4px"></div>
                </div>
                <p>Ingresa un monto para ver los resultados</p>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
/* ──────────── VARIABLES GLOBALES ──────────── */
const productoId = '{{ producto_id }}';
const plazoDias  = {{ plazo_dias }};
const tasaAnual  = {{ plazo_info.tasa_anual }};
const MAX_MESES  = 360;

// Información del producto y plazo
const producto = {{ producto | tojson }};
const plazoInfo = {{ plazo_info | tojson }};

/* Utilidades DOM / dinero */
const qs   = s => document.querySelector(s);
const money= v => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(v);

/* Estado de cálculo */
let isCalculating = false;
let lastCalculation = null;

/* ──────────── INIT ──────────── */
document.addEventListener('DOMContentLoaded', () => {
    console.log('💰 Calculadora MoneyMax iniciada');
    initInvestmentTypes();
    generatePlazoOptions();
    initCalculator();
});

/* ──────────── CONFIGURAR TIPOS DE INVERSIÓN ──────────── */
function initInvestmentTypes(){
    // Verificar qué tipos de inversión están permitidos
    const simpleRadio = qs('#simple');
    const mensualRadio = qs('#mensual');
    const radioGroup = qs('.radio-group');
    
    // Si el plazo no permite inversión mensual, ocultarla
    if(!plazoInfo.permite_inversion_mensual || !producto.permite_corrida_mensual){
        // Solo inversión única disponible
        mensualRadio.parentElement.style.display = 'none';
        simpleRadio.checked = true;
        
        // Si solo hay una opción, opcionalmente ocultar todo el grupo
        // radioGroup.style.display = 'none';
    }
    
    // Si es a la vista (plazo 0), configurar apropiadamente
    if(plazoDias === 0){
        qs('#plazoSelectGroup').style.display = simpleRadio.checked ? 'none' : 'block';
    }
}

/* ──────────── OPCIONES DE PLAZO ──────────── */
function generatePlazoOptions(){
    const sel = qs('#plazoMesesSelect');
    sel.innerHTML = '';
    const opts = [];
    
    // Generar opciones de meses
    for(let m = 1; m <= MAX_MESES; m++){
        if(m <= 24) opts.push(m);
        else if(m <= 60 && m % 6 === 0) opts.push(m);
        else if(m % 12 === 0) opts.push(m);
    }
    
    // Agregar el plazo del instrumento si no está
    const instr = Math.ceil(plazoDias / 30.44);
    if(!opts.includes(instr)) opts.push(instr);
    
    // Ordenar y crear opciones
    opts.sort((a, b) => a - b).forEach(m => {
        const o = document.createElement('option');
        o.value = m;
        o.textContent = m === 1 ? '1 mes' : 
                       m === 12 ? '1 año (12 meses)' : 
                       m % 12 === 0 ? `${m/12} años (${m} meses)` : 
                       `${m} meses`;
        if(m === 12) o.selected = true;
        sel.appendChild(o);
    });
}

/* ──────────── LISTENERS ──────────── */
function initCalculator(){
    // Listeners para tipo de inversión
    document.querySelectorAll('input[name="tipo_inversion"]').forEach(input => {
        input.addEventListener('change', e => {
            updateFormLabels(e.target.value);
            calculateInvestment();
        });
    });
    
    // Para el monto: calcular al escribir y al salir
    const montoInput = qs('#monto');
    montoInput.addEventListener('input', function() {
        validateMonto();
        debounce(calculateInvestment, 1000)();
    });
    montoInput.addEventListener('blur', calculateInvestment);
    
    // Para el select de plazo
    qs('#plazoMesesSelect').addEventListener('change', calculateInvestment);
    
    // Calcular inicial
    setTimeout(calculateInvestment, 100);
}

/* Cambiar etiquetas según tipo */
function updateFormLabels(tipo){
    const plazoGroup = qs('#plazoSelectGroup');
    const montoLabel = qs('#montoLabel');
    const montoInicialLabel = qs('#montoInicialLabel');
    
    if(tipo === 'mensual'){
        // Inversión mensual: mostrar selector de plazo
        plazoGroup.style.display = 'block';
        montoLabel.textContent = 'Monto mensual (MXN)';
        montoInicialLabel.textContent = 'Total aportado';
        qs('#monto').placeholder = '1,000';
    } else {
        // Inversión única: ocultar selector de plazo
        plazoGroup.style.display = 'none';
        montoLabel.textContent = 'Monto a invertir (MXN)';
        montoInicialLabel.textContent = 'Inversión inicial';
        qs('#monto').placeholder = '1,000';
    }
}

/* ──────────── VALIDACIÓN ──────────── */
function validateMonto(){
    const montoInput = qs('#monto');
    const monto = parseFloat(montoInput.value);
    const errorDiv = qs('#montoError');
    const successDiv = qs('#montoSuccess');
    
    // Limpiar mensajes previos
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    if(!montoInput.value || isNaN(monto)){
        return false;
    }
    
    if(monto < 100){
        errorDiv.textContent = 'El monto mínimo es $100 MXN';
        errorDiv.style.display = 'block';
        return false;
    }
    
    if(monto > 50000000){
        errorDiv.textContent = 'El monto máximo es $50,000,000 MXN';
        errorDiv.style.display = 'block';
        return false;
    }
    
    // Monto válido
    successDiv.textContent = '✓ Monto válido';
    successDiv.style.display = 'block';
    setTimeout(() => successDiv.style.display = 'none', 3000);
    return true;
}

/* ──────────── LLAMADA API ──────────── */
async function calculateInvestment(){
    // Evitar cálculos simultáneos
    if(isCalculating) return;
    
    const fd = new FormData(qs('#calculatorForm'));
    const monto = parseFloat(fd.get('monto'));
    const tipoInversion = fd.get('tipo_inversion');
    
    // Para inversión única, usar el plazo del producto
    // Para inversión mensual, usar el plazo seleccionado
    let meses;
    if(tipoInversion === 'simple'){
        meses = Math.ceil(plazoDias / 30.44) || 1;
    } else {
        meses = parseInt(fd.get('plazo_meses'));
    }
    
    // Validar datos
    if(!monto || isNaN(monto) || monto < 100 || !meses){
        console.log('Datos incompletos, saltando cálculo');
        return;
    }
    
    // Verificar si ya calculamos esto
    const calcKey = `${monto}-${meses}-${tipoInversion}`;
    if(lastCalculation === calcKey){
        console.log('Cálculo idéntico, saltando');
        return;
    }
    
    const payload = {
        producto_id: productoId,
        plazo_dias: plazoDias,
        plazo_meses_corrida: meses,
        monto: monto,
        tipo_inversion: tipoInversion
    };
    
    console.log('📊 Calculando:', payload);
    
    isCalculating = true;
    showLoading(true);
    showAutoCalcIndicator();
    clearErrors();
    
    try {
        const response = await fetch('/api/calcular', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        if(!response.ok){
            const errorData = await response.json();
            throw new Error(errorData.error || `Error ${response.status}`);
        }
        
        const data = await response.json();
        displayResults(data);
        lastCalculation = calcKey;
        
    } catch(error) {
        console.error('Error en cálculo:', error);
        showError(error.message);
        qs('#results').style.display = 'none';
        qs('#noResults').style.display = 'block';
    } finally {
        isCalculating = false;
        showLoading(false);
        hideAutoCalcIndicator();
    }
}

/* Función para forzar cálculo desde el botón */
function forceCalculate(){
    lastCalculation = null; // Resetear caché
    calculateInvestment();
}

/* ──────────── RESULTADOS ──────────── */
function displayResults(resp){
    const res = resp.resultado;
    const tabla = resp.tabla_crecimiento;
    
    console.log('📈 Mostrando resultados:', res);
    
    qs('#results').style.display = 'block';
    qs('#noResults').style.display = 'none';
    
    // Actualizar valores
    qs('#montoFinal').textContent = money(res.monto_final);
    qs('#rendimientoTotal').textContent = money(res.rendimiento_total);
    
    if(res.tipo_inversion === 'simple'){
        qs('#tasaEfectiva').textContent = res.tasa_efectiva.toFixed(2) + ' %';
        qs('#montoInicial').textContent = money(res.monto_inicial);
        qs('#plazoMesesRes').textContent = res.plazo_meses;
        
        // OCULTAR gráfica y tabla para inversión única
        qs('.chart-container').style.display = 'none';
        qs('.table-container').style.display = 'none';
    } else {
        qs('#tasaEfectiva').textContent = res.rendimiento_porcentual.toFixed(2) + ' %';
        qs('#montoInicial').textContent = money(res.total_aportado);
        qs('#plazoMesesRes').textContent = res.num_meses;
        
        // MOSTRAR gráfica y tabla para inversión mensual
        qs('.chart-container').style.display = 'block';
        qs('.table-container').style.display = 'block';
        
        // Crear visualizaciones solo para inversión mensual
        createChart(tabla, res.tipo_inversion);
        createTable(tabla, res.tipo_inversion);
    }
}

/* ──────────── GRÁFICA ──────────── */
function createChart(data, tipo){
    if(!data || data.length === 0) return;
    
    const x = data.map(r => `Mes ${r.mes}`);
    const traces = [];
    
    if(tipo === 'simple'){
        traces.push({
            x, y: data.map(r => r.monto_inicial || 0),
            type: 'scatter', mode: 'lines', name: 'Capital inicial',
            line: {color: '#e2e8f0', width: 2}, fill: 'tozeroy',
            fillcolor: 'rgba(226,232,240,.5)', stackgroup: 'one'
        });
        traces.push({
            x, y: data.map(r => r.rendimiento || 0),
            type: 'scatter', mode: 'lines', name: 'Intereses generados',
            line: {color: '#48bb78', width: 2}, fill: 'tonexty',
            fillcolor: 'rgba(72,187,120,.5)', stackgroup: 'one'
        });
        traces.push({
            x, y: data.map(r => r.monto_total),
            type: 'scatter', mode: 'lines+markers', name: 'Monto total',
            line: {color: '{{ producto.color_fondo }}', width: 3}, marker: {size: 6}
        });
    } else {
        traces.push({
            x, y: data.map(r => r.total_aportado || 0),
            type: 'scatter', mode: 'lines', name: 'Capital aportado',
            line: {color: '#e2e8f0', width: 2}, fill: 'tozeroy',
            fillcolor: 'rgba(226,232,240,.5)', stackgroup: 'one'
        });
        traces.push({
            x, y: data.map(r => r.total_rendimientos || 0),
            type: 'scatter', mode: 'lines', name: 'Intereses generados',
            line: {color: '#48bb78', width: 2}, fill: 'tonexty',
            fillcolor: 'rgba(72,187,120,.5)', stackgroup: 'one'
        });
        traces.push({
            x, y: data.map(r => r.monto_total),
            type: 'scatter', mode: 'lines+markers', name: 'Monto total',
            line: {color: '{{ producto.color_fondo }}', width: 3}, marker: {size: 6}
        });
    }
    
    const layout = {
        title: {
            text: `Evolución de tu inversión ${tipo === 'mensual' ? 'mensual' : 'única'}`,
            font: {size: 16, color: '#2d3748'}
        },
        xaxis: {title: 'Tiempo', gridcolor: '#f1f3f4'},
        yaxis: {title: 'Monto (MXN)', tickformat: '$,.0f', gridcolor: '#f1f3f4'},
        margin: {l: 80, r: 30, t: 60, b: 80},
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: {family: 'Arial, sans-serif'},
        legend: {orientation: 'h', y: -0.15, x: 0.5, xanchor: 'center'},
        hovermode: 'x unified'
    };
    
    Plotly.newPlot('chart', traces, layout, {responsive: true, displayModeBar: false});
}

/* ──────────── TABLA ──────────── */
function createTable(data, tipo){
    const head = qs('#tableHeaders');
    const body = qs('#tableBody');
    head.innerHTML = '';
    body.innerHTML = '';
    
    if(!data || data.length === 0) return;
    
    if(tipo === 'simple'){
        head.innerHTML = '<th>Mes</th><th>Días</th><th>Inversión inicial</th><th>Rendimiento</th><th>Monto total</th>';
        data.forEach(r => {
            body.insertAdjacentHTML('beforeend', `
                <tr>
                    <td>${r.mes}</td>
                    <td>${r.dias}</td>
                    <td>${money(r.monto_inicial)}</td>
                    <td>${money(r.rendimiento)}</td>
                    <td><strong>${money(r.monto_total)}</strong></td>
                </tr>
            `);
        });
    } else {
        head.innerHTML = '<th>Mes</th><th>Aportación</th><th>Total aportado</th><th>Rendimiento mes</th><th>Monto total</th>';
        data.forEach(r => {
            body.insertAdjacentHTML('beforeend', `
                <tr>
                    <td>${r.mes}</td>
                    <td>${money(r.aportacion)}</td>
                    <td>${money(r.total_aportado)}</td>
                    <td>${money(r.rendimiento_mes)}</td>
                    <td><strong>${money(r.monto_total)}</strong></td>
                </tr>
            `);
        });
    }
}

/* ──────────── HELPERS ──────────── */
function showLoading(show){
    qs('#loading').style.display = show ? 'block' : 'none';
    qs('#calculateBtn').disabled = show;
}

function showAutoCalcIndicator(){
    const indicator = qs('#autoCalcIndicator');
    indicator.style.display = 'block';
    setTimeout(() => indicator.style.display = 'none', 2000);
}

function hideAutoCalcIndicator(){
    qs('#autoCalcIndicator').style.display = 'none';
}

function clearErrors(){
    qs('#montoError').style.display = 'none';
}

function showError(msg){
    const errorDiv = qs('#montoError');
    errorDiv.textContent = msg;
    errorDiv.style.display = 'block';
}

function debounce(func, wait){
    let timeout;
    return function executedFunction(...args){
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/* ──────────── FORMATEO DE INPUT ──────────── */
// Mejorar la experiencia del input numérico
qs('#monto').addEventListener('keypress', function(e){
    // Permitir solo números y punto decimal
    const char = String.fromCharCode(e.which);
    if(!/[0-9.]/.test(char)){
        e.preventDefault();
    }
});
</script>
{% endblock %}